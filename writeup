import pandas as pd
from openpyxl import load_workbook

def copy_prod_data(df, file_path, sheet_name):
    try:
        # Step 1: Add "ApproachAndClass" column
        df['ApproachAndClass'] = df.iloc[:, -14].astype(str) + df.iloc[:, -13].astype(str)

        # Step 2: Add "Modified_Customer_Group" column
        df['Modified_Customer_Group'] = df.iloc[:, -12].apply(lambda x: 'PFS' if x == 'GPBB' else x)

        # Step 3: Open the XLSM file using openpyxl
        book = load_workbook(file_path, keep_vba=True)

        # Step 4: Write the DataFrame to the specified worksheet
        with pd.ExcelWriter(file_path, engine='openpyxl', mode='a') as writer:
            writer.book = book
            if sheet_name in book.sheetnames:
                # Remove the existing sheet to avoid duplication
                del book[sheet_name]
            
            # Create a new sheet and write data
            df.to_excel(writer, sheet_name=sheet_name, index=False)
            
            # Save the workbook with VBA enabled
            writer.save()

        print(f"Data written successfully to '{sheet_name}' in '{file_path}'.")

    except Exception as e:
        print(f"Error: {e}")

# Example Usage:
# Sample DataFrame
data = {
    'Col1': [1, 2, 3],
    'Col2': [4, 5, 6],
    'Col3': ['GPBB', 'ABC', 'XYZ'],
    'Col4': ['Test1', 'Test2', 'Test3'],
    'Col5': ['ClassA', 'ClassB', 'ClassC'],
}

# Convert to DataFrame
df = pd.DataFrame(data)

# File path and worksheet name
file_path = 'output.xlsm'
sheet_name = 'Production Data'

# Call the function
copy_prod_data(df, file_path, sheet_name)
