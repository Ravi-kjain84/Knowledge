import pandas as pd
from openpyxl import load_workbook

def copy_prod_data(df, file_path, sheet_name):
    try:
        # Step 1: Add "ApproachAndClass" column
        df['ApproachAndClass'] = df['ClassA'] + df['ClassB']

        # Step 2: Add "Modified_Customer_Group" column
        df['Modified_Customer_Group'] = df['Customer_Group'].apply(lambda x: 'PFS' if x == 'GPBB' else x)

        # Step 3: Open the XLSM file using openpyxl
        book = load_workbook(file_path, keep_vba=True)

        # Step 4: Remove existing sheet if it exists (to avoid duplication)
        if sheet_name in book.sheetnames:
            del book[sheet_name]

        # Step 5: Write data to new sheet using ExcelWriter
        with pd.ExcelWriter(file_path, engine='openpyxl', mode='a') as writer:
            # Pass the workbook directly to the writer
            writer._book = book
            df.to_excel(writer, sheet_name=sheet_name, index=False)

            # Save the workbook
            writer.close()

        print(f"Data written successfully to '{sheet_name}' in '{file_path}'.")

    except Exception as e:
        print(f"Error: {e}")

# Example Usage:
# Sample DataFrame
data = {
    'ID': [1, 2, 3],
    'Amount': [100, 200, 300],
    'Customer_Group': ['GPBB', 'ABC', 'XYZ'],
    'ClassA': ['Test1', 'Test2', 'Test3'],
    'ClassB': ['ClassA', 'ClassB', 'ClassC']
}

# Convert to DataFrame
df = pd.DataFrame(data)

# File path and worksheet name
file_path = 'output.xlsm'
sheet_name = 'Production Data'

# Call the function
copy_prod_data(df, file_path, sheet_name)
