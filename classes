import pandas as pd

class DataProcessor:
    def __init__(self, remind_file: str, remind_sheet: str, hub_file: str, hub_sheet: str, fusion_file: str, fusion_sheet: str, mapping_file: str, mapping_sheets: list):
        """
        Initialize the DataProcessor with file paths and sheet names for the required data files and mapping file.
        
        Args:
            remind_file (str): Path to the remind Excel file.
            remind_sheet (str): Sheet name in the remind Excel file.
            hub_file (str): Path to the hub Excel file.
            hub_sheet (str): Sheet name in the hub Excel file.
            fusion_file (str): Path to the fusion Excel file.
            fusion_sheet (str): Sheet name in the fusion Excel file.
            mapping_file (str): Path to the mapping Excel file.
            mapping_sheets (list): List of sheet names in the mapping Excel file.
        """
        self.remind_file = remind_file
        self.remind_sheet = remind_sheet
        self.hub_file = hub_file
        self.hub_sheet = hub_sheet
        self.fusion_file = fusion_file
        self.fusion_sheet = fusion_sheet
        self.mapping_file = mapping_file
        self.mapping_sheets = mapping_sheets
        self.remind_df = None
        self.hub_df = None
        self.fusion_df = None
        self.mapping_dfs = {}
        self.final_upload_df = None

    def import_data(self):
        """Import data from Excel files."""
        self.remind_df = pd.read_excel(self.remind_file, sheet_name=self.remind_sheet)
        self.hub_df = pd.read_excel(self.hub_file, sheet_name=self.hub_sheet)
        self.fusion_df = pd.read_excel(self.fusion_file, sheet_name=self.fusion_sheet)
        for sheet in self.mapping_sheets:
            self.mapping_dfs[sheet] = pd.read_excel(self.mapping_file, sheet_name=sheet)
        print("Data imported successfully.")

    def clean_remind_data(self):
        """Clean and map remind data with detailed operations."""
        # 1. Replace set of three characters with blank
        self.remind_df['SomeColumn'] = self.remind_df['SomeColumn'].str.replace('XYZ', '')
        
        # 2. Filter data based on account list from a mapping file
        account_list = self.mapping_dfs['AccountList']['Account'].tolist()
        self.remind_df = self.remind_df[self.remind_df['Account'].isin(account_list)]
        
        # 3. Exclude data based on customer list from a mapping file
        customer_list = self.mapping_dfs['CustomerList']['Customer'].tolist()
        self.remind_df = self.remind_df[~self.remind_df['Customer'].isin(customer_list)]
        
        # 4. Ensure unique entity-area pairs and merge back to remind data
        entity_area_df = self.mapping_dfs['EntityArea'][['Entity', 'Area']].drop_duplicates('Entity')
        self.remind_df = self.remind_df.merge(entity_area_df, on='Entity', how='left')
        
        # 5. Similar operation for another set of columns from another mapping file
        entity_product_df = self.mapping_dfs['EntityProduct'][['Entity', 'Product']].drop_duplicates('Entity')
        self.remind_df = self.remind_df.merge(entity_product_df, on='Entity', how='left')
        
        # 6. Remove rows where both identity and area columns are blank
        self.remind_df = self.remind_df[~(self.remind_df['Identity'].isna() & self.remind_df['Area'].isna())]
        
        # 7. Remove rows with specific amount types
        self.remind_df = self.remind_df[~self.remind_df['AmountType'].isin([53, 73])]
        
        # 8. Change the sign of Amount based on the Sign column
        self.remind_df['Amount'] = self.remind_df.apply(
            lambda x: x['Amount'] if x['Sign'] == '+' else -x['Amount'], axis=1
        )
        
        # 9. Create an AccountDetails column
        self.remind_df['AccountDetails'] = self.remind_df.apply(
            lambda x: f"{str(x['Branch']).zfill(3)}-{str(x['Serial']).zfill(6)}-{str(x['Suffix']).zfill(3)}",
            axis=1
        )
        
        # 10. Select specific columns and rename them
        self.remind_df = self.remind_df[['Identity', 'Entity', 'Amount', 'AccountDetails', 'LocalProductCode']]
        self.remind_df.columns = ['ReportingIdentity', 'Entity', 'Amount', 'AccountDetails', 'ProductCode']
        
        print("Remind data cleaned and mapped.")

    # Other methods (unchanged)
    def clean_hub_data(self):
        """Clean and map hub data."""
        # Example data cleaning and mapping logic
        self.hub_df.dropna(subset=['TransactionID'], inplace=True)
        self.hub_df['Amount'] = self.hub_df['Amount'].apply(lambda x: float(x.replace(',', '')))
        # Example of using a mapping sheet
        type_mapping = self.mapping_dfs['TransactionTypeMapping']
        self.hub_df = self.hub_df.merge(type_mapping, on='TransactionType', how='left')
        print("Hub data cleaned and mapped.")

    def compare_and_populate_entity(self):
        """Compare remind and hub data to populate entity column."""
        # Example comparison logic
        self.remind_df = self.remind_df.merge(self.hub_df[['TransactionID', 'Entity']], on='TransactionID', how='left')
        self.remind_df['Entity'].fillna('Unknown', inplace=True)
        print("Entity column populated in remind data.")

    def get_cpa_details(self):
        """Get details of CPA."""
        # Example CPA details logic
        cpa_details = self.remind_df[self.remind_df['TransactionType'] == 'CPA']
        print("CPA details retrieved.")
        return cpa_details

    def create_control_dashboard(self, filename: str):
        """Create control dashboard in Excel."""
        # Example control dashboard logic
        summary = self.remind_df.groupby('Entity')['Amount'].sum().reset_index()
        with pd.ExcelWriter(filename) as writer:
            self.remind_df.to_excel(writer, sheet_name='Remind Data', index=False)
            self.hub_df.to_excel(writer, sheet_name='Hub Data', index=False)
            summary.to_excel(writer, sheet_name='Summary', index=False)
        print("Control dashboard created in Excel.")

    def get_entity_details(self):
        """Get entity details using fusion data."""
        # Example entity details logic
        entity_details = self.fusion_df[['EntityID', 'Detail']]
        self.remind_df = self.remind_df.merge(entity_details, left_on='Entity', right_on='EntityID', how='left')
        print("Entity details retrieved from fusion data.")
        return entity_details

    def gather_final_upload_details(self):
        """Gather all details and place them in final upload data frame."""
        # Example gathering final details logic
        self.final_upload_df = pd.merge(self.remind_df, self.hub_df[['TransactionID', 'HubSpecificColumn']], on='TransactionID', how='left')
        print("Final upload details gathered.")

    def export_to_excel(self, filename: str):
        """Export data to Excel with required formatting."""
        # Example export logic
        with pd.ExcelWriter(filename) as writer:
            self.final_upload_df.to_excel(writer, sheet_name='Final Upload', index=False)
            # Applying formatting
            workbook = writer.book
            worksheet = writer.sheets['Final Upload']
            format1 = workbook.add_format({'num_format': '#,##0.00'})
            worksheet.set_column('A:Z', 18, format1)
        print("Data exported to Excel with formatting.")

    def populate_control_data(self, filename: str):
        """Populate control data into Excel with required formatting."""
        # Example control data logic
        control_data = self.final_upload_df[['Entity', 'Amount', 'HubSpecificColumn']]
        with pd.ExcelWriter(filename) as writer:
            control_data.to_excel(writer, sheet_name='Control Data', index=False)
            # Applying formatting
            workbook = writer.book
            worksheet = writer.sheets['Control Data']
            format1 = workbook.add_format({'num_format': '#,##0.00', 'bold': True})
            worksheet.set_column('A:Z', 18, format1)
        print("Control data populated into Excel with formatting.")
